const json = '[{"id":"104a84fb-2e5b-4562-8468-8927d9c845d9","name":"etc","nodes":[{"id":"411928db-e515-4bda-8437-ecf89c42ead3","name":"alphbet","nodes":[{"id":"c608f23e-b80c-4443-a057-1cb17575acae","name":"а","open":true},{"id":"35bbc2f6-7e84-4dd7-8437-59e218a87546","name":"б","open":true},{"id":"682c0519-8f04-4c00-9896-0df68e513aae","name":"в","open":true},{"id":"91f2803e-1936-4f1f-a7b5-140a1fd62b45","name":"г","open":true},{"id":"bb7abd31-a32f-414a-b0c7-0756c47966f2","name":"д","open":true},{"id":"a35290f4-9579-4142-bdfe-e523d40e0d33","name":"е","open":true},{"id":"f1df2180-1411-4962-8231-10a7fdf3e4f7","name":"ё","open":true},{"id":"ea5b538a-4867-4590-bfa3-ab20c4930404","name":"и","open":true},{"id":"c7c4759b-3378-4878-b695-86d4e26c115f","name":"й","open":true},{"id":"a9903411-3534-4296-a3be-e2bb465cb50e","name":"к","open":true},{"id":"bb37fa24-b9b4-411f-9976-ae7cbe307ac9","name":"л","open":true},{"id":"dc8c73d5-e658-41ab-a2b1-77545ace62a0","name":"м","open":true},{"id":"6c02aa93-9bff-46c9-a75e-a66e6f2173c7","name":"н","open":true},{"id":"b547b394-15b1-45f7-acdf-d8256c5c4a0a","name":"о","open":true},{"id":"a4c69673-b39e-4695-9fb8-85fead204bbe","name":"п","open":true},{"id":"19e59c5a-c33a-435e-bedb-3d715859a886","name":"р","open":true},{"id":"57a99f01-732f-4017-aac0-86a9d77696f8","name":"с","open":true},{"id":"b8f61f47-5d15-437a-b859-be0e73b3eaf1","name":"т","open":true},{"id":"b0a8dbac-343c-4ac3-812b-20f9571710cd","name":"у","open":true},{"id":"6f9355fe-f0d4-4e8d-9a01-4d7b66907035","name":"ф","open":true},{"id":"9993d79e-26a1-49a2-bdda-2aaf61a00a81","name":"х","open":true},{"id":"6de9fefe-c00b-4d2e-a882-2060fcec756f","name":"ц","open":true},{"id":"dcc2e351-a3c1-4755-a686-60ad5da86616","name":"ч","open":true},{"id":"9c4d8c67-168a-4e34-99f4-e8f38d46bad3","name":"ш","open":true},{"id":"aef118dd-21c6-40db-93d1-d5bb220dfefd","name":"щ","open":true},{"id":"e372e1a2-1474-4992-8654-f848176dc232","name":"ъ","open":true},{"id":"eb0c8c87-fc90-42bd-a725-b7ae712e6fca","name":"ы","open":true},{"id":"d659d0f3-7957-431c-86b3-41cd4a469e38","name":"ь","open":true},{"id":"10a21cde-1c18-4914-b3a4-dc5f685fe2c0","name":"э","open":true},{"id":"03defd50-b3d5-49ad-b588-8a12691d6954","name":"ю","open":true},{"id":"3e4a3478-b800-4da4-a019-7e8e98046184","name":"я","open":true}]},{"id":"af54e893-4547-414c-ac69-0e9d0812d6df","name":"finder"},{"id":"e5241b70-4065-4a98-8132-5cb937562056","name":"words","nodes":[{"id":"fd170eb3-459b-4f89-a092-b412b980d840","name":"бытие"},{"id":"9088b80f-cf2c-4a22-8a83-5184bbfa9c3e","name":"караван"},{"id":"a68541c5-9f12-4a3e-8916-35a4cea3bc9b","name":"карма"},{"id":"cef1980d-b104-4221-8ce7-8c4c837aa0fd","name":"паренхима"},{"id":"832a2213-8056-4049-86a2-f2e78404a3c8","name":"статика"},{"id":"88ee4eb7-02cd-496e-80f1-a51def8a124c","name":"сущее"},{"id":"7ff67a3a-f4c8-4fc6-9263-9415443f0966","name":"трансцендентность"},{"id":"4232b072-e5bf-47a4-b246-7e461ea20c02","name":"философия"}]}]},{"id":"75eada03-bc5b-4558-89cb-91f726e5269b","name":"media","nodes":[{"id":"5291935c-99d1-447a-80b6-e5c707a86477","name":"games","nodes":[{"id":"7b593f20-4075-4884-849e-0d7a06ec53e6","name":"ace combat"},{"id":"84f30713-0f85-4ca1-a078-98cec93da87c","name":"battlefield"},{"id":"a9aa4621-a1b4-4faa-b35d-6575549383db","name":"carmagedon"},{"id":"712e2018-64ab-421e-924a-dee41ca6d912","name":"crash bandicoot"},{"id":"7105ded8-1b13-4a01-81eb-f057152c8e0f","name":"death stranding"},{"id":"9e320a08-f193-4250-98d3-a6d9070558b7","name":"doom"},{"id":"d891e252-b3e8-4ae4-bac5-a6b3203c9a63","name":"god of war"},{"id":"fa3279da-959f-46e4-a7ae-b83805f67a9e","name":"metal gear solid"},{"id":"7bc23377-26f8-480c-ab1f-09da299b407c","name":"S.T.A.L.K.E.R. 2: Heart of Chornobyl"},{"id":"c22d33f9-7c4e-4aa0-bde1-7eb5d20cca8b","name":"tekken"},{"id":"b11016c9-04f7-4c23-8509-0045cb68a0a9","name":"vigilante 8"}]},{"id":"713fe0f0-4266-4844-aac9-b70b869e98fe","name":"soft","nodes":[{"id":"22ca40e9-ec95-4476-9931-a6817fb746ee","name":"dropbox"},{"id":"7f7ade58-5f67-4be0-a2e8-9bb7843ccb4e","name":"google drive"}]},{"id":"5b324af2-4179-4bba-b878-2c429ad0d572","name":"video","nodes":[{"id":"e2442ac0-92a7-4e54-9f23-7642eb3a2db8","name":"https://i.imgur.com/ydfq78N.mp4"}]}]},{"id":"e204881a-81b2-46d5-91f5-ebbd99fb9215","name":"scripts","open":true,"nodes":[{"id":"1b58e3c2-57f9-4d22-b0d1-8d16a06b29ba","name":"js","open":true,"nodes":[{"id":"10e192a0-cfb1-4126-b028-7d17c4c84508","name":"http","open":true,"js":"() => {\\n\\n    return class {\\n        constructor(baseUrl, headers) {\\n            if (!headers[\'Content-Type\']) headers[\'Content-Type\'] = \'application/json\';\\n        }\\n        \\n        async get(url, params = {}, headers = {}, options = {}) {\\n            \\n            let timeoutId;\\n            const controller = new AbortController();\\n            if (options.timeout) timeoutId = setTimeout(() => controller.abort(), options.timeout);\\n    \\n            if (Object.keys(params).length > 0) url += \'?\' + new URLSearchParams(params);\\n    \\n            const response = await fetch(url, {headers, signal: controller.signal});\\n            if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; }\\n    \\n            return {\\n                statusCode: response.status,\\n                data: await response.json(),\\n                headers: response.headers\\n            }\\n        }\\n    }\\n\\n}"}]}]}]';

const x = new Proxy({}, {
    get(target, prop, receiver) {
        //return y.node; // (1)
    },
});
const y = {
    __std__: {
        nodes: JSON.parse(json),
    },
    __ext__: {
        express: (await import("express")).default,
        bodyParser: (await import("body-parser")).default,
    }
}

const main = async () => {
    if (typeof window !== 'undefined') { await browser(); return; }

    const {parseCliArgs} = await import("./src/F.js");
    const Logger = (await import("./src/log/Logger.js")).default;
    const fs = (await import("./src/io/fs/FS.js")).default;
    const cliArgs = parseCliArgs(process.argv);
    const logger = new Logger(fs);

    await runLoopService(cliArgs, {fs, logger});
}

const runLoopService = async (cliArgs, deps) => {
    const {logger} = deps;
    const {uuid, unixTs} = (await import("./src/F.js"));

    const nodes = y.__std__.nodes;
    const nodesById = {};

    const iterNodes = (nodesArr, parentId = null, path = '') => {
        for (let i = 0; i < nodesArr.length; i++) {
            let node = nodesArr[i];
            if (!node.name) {
                logger.error('node name is not defined', node);
                continue;
            }
            if (parentId) node.parentId = parentId;
            nodesById[node.id] = node;

            if (node.js) node['__js__'] = eval(node.js);
            if (Array.isArray(node.nodes)) {
                iterNodes(node.nodes, node.id, path ? (path + '.' + node.name) : node.name);
            }
        }
    }
    iterNodes(nodes);

    const log = async (rq, rs, nx) => { logger.info(rq.method + ' ' + rq.path); nx(); }
    const api = async (rq, rs, nx) => {

        rs.setHeader('Access-Control-Allow-Origin', '*');
        rs.setHeader('Access-Control-Allow-Headers', "Content-Type, Authorization, X-Requested-With");

        if (rq.path === '/getState') rs.send(y.__std__.nodes);
        else if (rq.path === '/console') {}
        else if (rq.path === '/setKey') {

            const nodeId = rq.body.nodeId;
            const k = rq.body.k;
            const v = rq.body.v;

            if (!nodeId) { rs.send({err: 'nodeId is empty'}); return; }
            if (!k) { rs.send({err: 'k is empty'}); return; }
            if (!v) { rs.send({err: 'v is empty'}); return; }

            const node = nodesById[nodeId];
            if (!node)  { rs.send({err: 'node not found'}); return; }

            node[k] = v;
            if (k === 'js') node['__js__'] = eval(v);
            rs.send(node);
        }
        nx();
    }
    const e = y.__ext__.express();
    e.use(y.__ext__.bodyParser.json({limit: '25mb'}), log, api);
    const s = (await import("node:http")).createServer({}, e);
    const p = cliArgs.port || 8099;
    s.listen(p, (err) => logger.info(`Server listening on port ${p}`));
}


const browser = async () => {
    const Browser = (await import("./src/BrowserLogic.js")).default;
    (new Browser()).run();
};

main();
